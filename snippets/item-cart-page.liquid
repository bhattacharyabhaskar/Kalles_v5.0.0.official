{%- comment -%}
  Renders a item cart page

  Accepts:
  - item: {Object} (required)
  - form_id: {String} (required)

  Usage:
  {%- render 'item-cart-page', item: item, form_id: form_id -%}
{%- endcomment -%}
{%- assign image  = item.image | default: settings.placeholder_img -%}
<hdt-line-item class="hdt-line-item{% if item.variant.id == gift_wrap_pr_id %} is-gift-wrap{% endif %}">
  <div class="hdt-page-cart__infos-wrap hdt-flex hdt-align-center">
    <div class="hdt-page-cart__image">
      <a href="{{ item.url }}" class="hdt-page-cart__img hdt-block hdt-relative hdt-oh hdt-ratio" style="--aspect-ratioapt:{{ image.aspect_ratio | default: 0.6811989100817438 }}">
        {%- if image != blank -%}
          {{ image | image_url: width: image.width | image_tag: loading: 'lazy', width: image.width, height: image.height, sizes: '(max-width: 767px) 80px, 160px', widths: '80, 160' }}
        {%- else -%}
          <span class="hdt-page-cart__img-placeholder"></span>
        {%- endif -%}
      </a>
    </div>
    <div class="hdt-page-cart__info">
      <a href="{{ item.url }}" class="hdt-page-cart__title hdt-text-base hdt-font-semibold hdt-s-text">{{ item.product.title }}</a>
      <div class="hdt-page-cart__meta-variant">
        {%- if item.product.has_only_default_variant == false -%}
          {%- for option in item.options_with_values -%}
            <div class="hdt-product-option">
              <span>{{ option.name }}:<strong> {{ option.value -}}</strong></span>
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>
      {%- if item.properties.size != 0 -%}
        <ul class="hdt-page-cart__meta-propertyList hdt-s-text2">
          {%- for property in item.properties -%}
            {%- assign property_first_char = property.first | slice: 0 -%}
            {%- if property.last != blank and property_first_char != '_' -%}
              <li class="hdt-product-option hdt-product-details__item hdt-product-details__item--property">
                <span class="hdt-product-details__item-label"><strong class="hdt-font-normal">{{ property.first }}: </strong></span>
                <span>
                  {%- if property.last contains '/uploads/' -%}
                    <a href="{{ property.last }}" target="_blank" aria-describedby="a11y-new-window-message">{{ property.last | split: '/' | last }}</a>
                  {%- else -%}
                    {{ property.last }}
                  {%- endif -%}
                </span>
              </li>
            {%- endif -%}
          {%- endfor -%}
        </ul>
      {%- endif -%}
      {%- if item.line_level_discount_allocations.size != 0 -%}
        <ul class="hdt-discounts hdt-cart_discounts hdt-font-normal" role="list" aria-label="{{ 'customer.order.discount' | t }}">
          {%- for discount in item.line_level_discount_allocations -%}
            <li class="hdt-discounts__discount hdt-page-cart-discount_item">{% render 'icon' with 'discount' %} {{ discount.discount_application.title }}</li>
          {%- endfor -%}
        </ul>
      {%- endif -%}
      {%- if item.selling_plan_allocation != null %}<p class="hdt-product-option">{{ item.selling_plan_allocation.selling_plan.name }}</p>{% endif -%}
      <div class="hdt-flex hdt-align-center hdt-justify-start">
        <wrapp-remove-item-oncart placement="none" class="hdt-inline-flex hdt-align-center" style="margin-inline-end: 10px" data-index="{{ item.index | plus: 1 }}" form="id:{{ form_id }}">
          {% comment %}          
          <a href="{{ routes.cart_change_url }}?line={{ item.index | plus: 1 }}&quantity=0" class="hdt-mini-cart__remove hdt-s-text">
            <svg viewBox="0 0 24 24" width="17"><use href="#icon-cart-remove"></use></svg>
          </a>
          {% endcomment %}
           <button
            type="button"
            class="t4s-mini_cart__remove-btn"
            data-item-key="{{ item.key }}"
            onclick="handleCartRemove(event)">
            Delete
          </button>

        </wrapp-remove-item-oncart>
        {% comment %} {%- if item.product.variants.size > 1 or qty_rules or item.product.selling_plan_groups.size > 0 -%}
          <wrapp-hdt-open-modal-btn class="hdt-ultra_btn_parent hdt-inline-flex hdt-align-center {{ class }}" placement="{{ placement | default: 'none' }}" {{ tooltip_auto }} style="margin-inline-end: 10px">
            <button type="button" handle="{{ item.product.handle }}" aria-controls="hdt-quick-add-modal" aria-expanded="false" class="hdt-card-product__btn-ultra">
              <span class="hdt-pr-card-icon">
                <svg viewBox="0 0 24 24" width="17"><use href="#icon-cart-edit"/></svg>
              </span>
              <span class="hdt-truncate{% unless disable_sr_only %} sr-only{% endunless %}">{{ 'products.product.quick_add' | t }}</span>
            </button>
          </wrapp-hdt-open-modal-btn>
        {%- endif -%} {% endcomment %}
      </div>
    </div>
  </div>
</hdt-line-item>
<div id="ivy-loader" style="display:none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.9); padding: 20px; border-radius: 10px; z-index: 9999;">
  <svg width="40" height="40" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid">
    <circle cx="50" cy="50" r="32" stroke-width="8" stroke="#a00000" stroke-dasharray="50.26548245743669 50.26548245743669" fill="none" stroke-linecap="round">
      <animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" keyTimes="0;1"
        values="0 50 50;360 50 50"></animateTransform>
    </circle>
  </svg>
  <div style="margin-top: 10px; text-align:center; font-weight: 600;">Removing items...</div>
</div>

<script>async function handleCartRemove(event) {
  console.log("üß© handleCartRemove triggered");
  const button = event.currentTarget;

  const loader = document.getElementById('ivy-loader');
  loader.style.display = 'block'; // üëà Show loader

  const itemKeyToRemove = button.dataset.itemKey;

  if (!itemKeyToRemove) {
    console.warn("‚ùå itemKey missing on button");
    loader.style.display = 'none'; // üëà Hide loader on early exit
    return;
  }

  const cartData = await fetch('/cart.js').then(res => res.json());
  const lineItems = cartData.items;
  console.log("üßæ Initial cart contents:", lineItems);

  const lineItemsToRemove = [];

  const parentLineIndex = lineItems.findIndex(item => item.key === itemKeyToRemove);
  if (parentLineIndex === -1) {
    console.warn("‚ùå Parent item not found");
    loader.style.display = 'none'; // üëà Hide loader on error
    return;
  }

  const parentVariantId = lineItems[parentLineIndex].variant_id;
  console.log("üÜî parentVariantId:", parentVariantId);

  lineItemsToRemove.push(parentLineIndex + 1);

  for (let i = 0; i < lineItems.length; i++) {
    const linked = lineItems[i].properties?.['Linked to Saree'];
    if (linked && parseInt(linked) === parentVariantId) {
      console.log(`üóë Marking ${lineItems[i].title} for removal (line ${i + 1})`);
      lineItemsToRemove.push(i + 1);
    }
  }

  lineItemsToRemove.sort((a, b) => b - a);
  console.log("üì§ Will remove lines:", lineItemsToRemove);

  for (const line of lineItemsToRemove) {
    const res = await fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ line, quantity: 0 })
    });

    if (!res.ok) {
      const err = await res.text();
      console.error(`‚ùå Failed to remove line ${line}:`, res.status, err);
    }
  }

  // Optional small delay for better UX
  setTimeout(() => {
    window.location.reload();
  }, 300);
}
</script>



<style>
.t4s-mini_cart__remove-btn {
  background-color: #ffffff;
  color: #a00000;
  border: 1.5px solid #a00000;
  padding: 6px 14px;
  border-radius: 6px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s ease, color 0.2s ease;
}

.t4s-mini_cart__remove-btn:hover {
  background-color: #a00000;
  color: #ffffff;
}

.t4s-mini_cart__remove-btn:disabled {
  background-color: #eee;
  color: #aaa;
  border-color: #ccc;
  cursor: not-allowed;
}
</style>          