<script>
async function handleAddToCart(e) {
  e.preventDefault();
  e.stopPropagation();

  submitButton.disabled = true;
  floatingBtn.disabled = true;
  submitButton.innerText = 'Adding...';
  floatingBtn.innerText = 'Adding...';

  const checkedAddons = Array.from(document.querySelectorAll('.addon-checkbox:checked'))
    .map(cb => cb.getAttribute('data-variant-id'))
    .filter(Boolean);

  try {
    // Step 1: Remove matching parent + linked add-ons
    const cart = await fetch('/cart.js').then(res => res.json());
    const updates = {};
    cart.items.forEach(item => {
      const linked = item.properties?.['Linked to Saree'];
      if (item.variant_id == parentVariantId || linked == parentVariantId) {
        updates[item.key] = 0;
      }
    });

    if (Object.keys(updates).length > 0) {
      await fetch('/cart/update.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ updates })
      });
      await new Promise(res => setTimeout(res, 300));
    }

    // Step 2: Add parent + selected add-ons
    const itemsToAdd = [
      ...checkedAddons.map(id => ({
        id,
        quantity: 1,
        properties: { "Linked to Saree": parentVariantId }
      })),
      {
        id: parentVariantId,
        quantity: 1
      }
    ];

    const addRes = await fetch("/cart/add.js", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ items: itemsToAdd })
    });

    if (!addRes.ok) throw new Error("❌ Failed to add items");

    // Step 3: Let theme update and open the drawer
    const event = new CustomEvent("cart:refresh", {
      bubbles: true,
      detail: {
        sections: ['cart_drawer', 'cart_icon', 'cart_data', 'mini_cart'],
        scrollToTop: false,
        openDrawer: true // KEY for native behavior
      }
    });
    document.dispatchEvent(event);

  } catch (err) {
    console.error("❌ Cart Update Error:", err);
    alert("Something went wrong. Please try again.");
  } finally {
    submitButton.disabled = false;
    floatingBtn.disabled = false;
    updateATCButtonText();
  }
}

</script>
