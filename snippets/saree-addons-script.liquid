<script>
document.addEventListener("DOMContentLoaded", function () {
  const atcButton = document.querySelector('form[action="/cart/add"] button[type="submit"]');
  if (atcButton) {
    atcButton.addEventListener("click", handleAddToCart);
    console.log("‚úÖ Bound custom handleAddToCart to button");
  } else {
    console.warn("‚ùå ATC button not found");
  }
});

async function handleAddToCart(e) {
  console.log("üõí Add to Cart triggered...");
  e.preventDefault();

  const submitBtn = e.currentTarget;
  submitBtn.disabled = true;

  const spinner = submitBtn.querySelector('.hdt-loading__spinner');
  const btnText = submitBtn.querySelector('.hdt-btn-atc_text');
  if (spinner) spinner.removeAttribute('hidden');
  if (btnText) btnText.textContent = 'Adding...';

  // ‚úÖ Get selected variant from the form
  const variantInput = document.querySelector('form[action="/cart/add"] input[name="id"]');
  const parentVariantId = variantInput?.value;

  if (!parentVariantId) {
    alert("Variant not found");
    return;
  }

  // ‚úÖ Get selected add-ons
  const addonItems = Array.from(document.querySelectorAll('.addon-checkbox:checked'))
    .map(cb => {
      const variantId = cb.getAttribute('data-variant-id');
      return variantId ? {
        id: parseInt(variantId),
        quantity: 1,
        properties: {
          "Linked to Saree": parentVariantId
        }
      } : null;
    })
    .filter(Boolean);

  const mainItem = {
    id: parseInt(parentVariantId),
    quantity: 1
  };

  const items = [mainItem, ...addonItems];

  console.log("‚úîÔ∏è Parent Variant ID:", parentVariantId);
  console.log("‚ûï Addon Items:", addonItems);
  console.log("üì¶ Final items array:", items);

  try {
    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    });

    if (!res.ok) throw new Error("Failed to add to cart");

    document.dispatchEvent(new CustomEvent("cart:refresh"));
  } catch (err) {
    console.error("‚ùå Add to cart failed", err);
    alert("Something went wrong. Please try again.");
  } finally {
    submitBtn.disabled = false;
    if (spinner) spinner.setAttribute('hidden', '');
    if (btnText) btnText.textContent = 'Add to cart';
  }
}
</script>
