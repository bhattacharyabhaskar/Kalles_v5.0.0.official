<script>
async function handleAddToCart(e) {
  console.log("🛒 Add to Cart triggered...");
  e.preventDefault();

  const submitBtn = e.currentTarget;
  submitBtn.disabled = true;
  submitBtn.innerText = 'Adding...';

  const parentVariantId = window?.product?.selected_or_first_available_variant?.id?.toString();
  if (!parentVariantId) {
    alert("❌ Variant not found");
    return;
  }

  console.log("✔️ Parent Variant ID:", parentVariantId);

  // Add-on variants
  const addonItems = Array.from(document.querySelectorAll('.addon-checkbox:checked'))
    .map(cb => {
      const variantId = cb.getAttribute('data-variant-id');
      return variantId ? {
        id: parseInt(variantId),
        quantity: 1,
        properties: {
          "Linked to Saree": parentVariantId
        }
      } : null;
    })
    .filter(Boolean);

  console.log("➕ Addon Items:", addonItems);

  // Main product
  const mainItem = {
    id: parseInt(parentVariantId),
    quantity: 1
  };

  const items = [mainItem, ...addonItems];
  console.log("📦 Final items array:", items);

  try {
    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ items })
    });

    if (!res.ok) throw new Error("❌ Failed to add to cart");

    // ✅ Open drawer using native icon
    tryOpenCartDrawer();
  } catch (err) {
    console.error("❌ Add to cart failed", err);
    alert("Something went wrong. Please try again.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'Add to Cart';
  }
}

// Helper to open drawer via Kalles cart icon
function tryOpenCartDrawer() {
  const nativeBtn = document.querySelector('[data-hdt-open-drawer="cart"], [data-open-drawer="cart"]');
  if (nativeBtn) {
    console.log("🛎️ Triggering native cart icon click...");
    nativeBtn.click();
  } else {
    console.warn("❌ Could not find cart icon to trigger drawer");
  }
}
</script>
