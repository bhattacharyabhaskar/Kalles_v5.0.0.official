{% comment %} Injected via saree-addons-script.liquid {% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const parentInput = document.querySelector('input[name="id"]');
  if (!parentInput) return;
  const parentVariantId = parseInt(parentInput.value);

  const addonInputs = document.querySelectorAll('.ivy-upsell-checkbox[type="checkbox"]');

  const form = parentInput.closest('form');
  if (!form) return;

  const atcButton = form.querySelector('[type="submit"]');
  if (!atcButton) return;

  // Helper to remove old instances
  function removeExistingSareeAndAddons(parentVariantId) {
    return fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const updates = {};
        cart.items.forEach(item => {
          const isParent = item.variant_id === parentVariantId;
          const isAddon = item.properties && item.properties['Linked to Saree'] == parentVariantId;
          if (isParent || isAddon) {
            updates[item.key] = 0;
            console.log('ðŸ§¹ Marking for removal:', item.key, item.title);
          }
        });

        if (Object.keys(updates).length > 0) {
          console.log('ðŸ§¹ Sending cart update to remove old items...');
          return fetch('/cart/update.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates })
          }).then(() => {
            console.log('âœ… Old items removed.');
          });
        } else {
          console.log('âš ï¸ No matching old items found.');
          return Promise.resolve();
        }
      })
      .catch(err => {
        console.error('âŒ Error removing old items', err);
      });
  }

  form.addEventListener('submit', function (e) {
    const selectedAddons = Array.from(addonInputs).filter(input => input.checked);
    if (selectedAddons.length === 0) return; // Let normal form post run if no add-ons

    e.preventDefault();
    console.log(`ðŸ“¦ Add-ons selected: ${selectedAddons.length}`);

    removeExistingSareeAndAddons(parentVariantId).then(() => {
      // Inject selected add-ons into form
      selectedAddons.forEach(input => {
        const variantId = input.dataset.variant;
        const inputId = document.createElement('input');
        inputId.type = 'hidden';
        inputId.name = 'items[][id]';
        inputId.value = variantId;

        const inputQty = document.createElement('input');
        inputQty.type = 'hidden';
        inputQty.name = 'items[][quantity]';
        inputQty.value =