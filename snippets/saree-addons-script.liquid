<script>
  async function handleAddToCart(e) {
    console.log("🛒 Add to Cart triggered...");

    e.preventDefault();
    const submitBtn = e.currentTarget;
    submitBtn.disabled = true;
    submitBtn.innerText = 'Adding...';

    // ✅ Fallback logic to get the parentVariantId safely
    const parentVariantId =
      document.querySelector('form[action="/cart/add"] input[name="id"]')?.value ||
      ShopifyAnalytics?.meta?.selectedVariantId?.toString();

    if (!parentVariantId) {
      alert("❌ Variant not found");
      return;
    }

    // ✅ Gather add-on checkboxes
    const addonItems = Array.from(document.querySelectorAll('.addon-checkbox:checked'))
      .map(cb => {
        const variantId = cb.getAttribute('data-variant-id');
        return variantId ? {
          id: parseInt(variantId),
          quantity: 1,
          properties: {
            "Linked to Saree": parentVariantId
          }
        } : null;
      })
      .filter(Boolean);

    // ✅ Main product
    const mainItem = {
      id: parseInt(parentVariantId),
      quantity: 1
    };

    const items = [mainItem, ...addonItems];

    // ✅ Debug logs
    console.log("✔️ Parent Variant ID:", parentVariantId);
    console.log("➕ Addon Items:", addonItems);
    console.log("📦 Final items array:", items);

    try {
      const res = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items })
      });

      if (!res.ok) throw new Error("❌ Failed to add to cart");

      // ✅ Trigger cart refresh (Kalles v5 will open drawer)
      document.dispatchEvent(new CustomEvent("cart:refresh"));
    } catch (err) {
      console.error("❌ Add to cart failed", err);
      alert("Something went wrong. Please try again.");
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerText = 'Add to Cart';
    }
  }

  // ✅ Attach handler to native and floating ATC buttons
  document.addEventListener("DOMContentLoaded", function () {
    const btns = document.querySelectorAll('button[type="submit"], #floating-atc-btn');
    btns.forEach(btn => {
      btn.addEventListener("click", handleAddToCart);
    });
  });
</script>
