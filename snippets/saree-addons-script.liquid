<script>
async function handleAddToCart(e) {
  e.preventDefault();
  console.log("ğŸ›’ Add to Cart triggered...");

  const submitBtn = e.currentTarget;
  submitBtn.disabled = true;
  submitBtn.innerText = 'Adding...';

  // 1. Try to get parent variant ID safely
  const variantInput = document.querySelector('form[action="/cart/add"] input[name="id"], input[name="variant"], input[name="variant_id"]');
  const parentVariantId = variantInput?.value || window?.product?.selected_or_first_available_variant?.id;

  if (!parentVariantId) {
    alert("Variant not found");
    console.warn("âŒ Could not determine parentVariantId", { variantInput, windowProduct: window.product });
    submitBtn.disabled = false;
    submitBtn.innerText = 'Add to Cart';
    return;
  }

  console.log("âœ”ï¸ Parent Variant ID:", parentVariantId);

  // 2. Collect checked add-ons
  const addonCheckboxes = Array.from(document.querySelectorAll('.addon-checkbox:checked'));
  const addonItems = addonCheckboxes.map(cb => {
    const variantId = cb.getAttribute('data-variant-id');
    return variantId ? {
      id: parseInt(variantId),
      quantity: 1,
      properties: {
        "Linked to Saree": parentVariantId
      }
    } : null;
  }).filter(Boolean);

  console.log("â• Addon Items:", addonItems);

  // 3. Build final items array
  const items = [
    { id: parseInt(parentVariantId), quantity: 1 },
    ...addonItems
  ];

  console.log("ğŸ“¦ Final items array:", items);

  try {
    const res = await fetch('/cart/add.js', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ items })
    });

    if (!res.ok) throw new Error("âŒ Failed to add to cart");

    console.log("âœ… Items successfully added");

    // 4. Refresh cart and open drawer
    //document.dispatchEvent(new CustomEvent("cart:refresh")); // for custom Kalles logic
    //document.dispatchEvent(new CustomEvent("hdt:open-drawer", { detail: { id: "cart" } }));
    refreshCartUI();


  } catch (err) {
    console.error("âŒ Add to cart failed", err);
    alert("Something went wrong. Please try again.");
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'Add to Cart';
  }
}

// Attach to button if not using Liquid 'onclick'
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('button[name="add"]');
  if (btn) {
    btn.addEventListener('click', handleAddToCart);
    console.log("âœ… Bound custom handleAddToCart to button");
  } else {
    console.warn("âŒ No Add to Cart button found");
  }
});

// After items are successfully added...
function refreshCartUI() {
  console.log("ğŸ”„ Triggering cart refresh and drawer open...");

  // 1. Refresh cart data & count
  fetch('/cart.js')
    .then(res => res.json())
    .then(cart => {
      // Dispatch refresh event (Kalles listens for this)
      document.dispatchEvent(new CustomEvent("cart:refresh", { detail: cart }));

      // Update cart count manually (if needed)
      const cartCountEls = document.querySelectorAll('.hdt-cart-count');
      cartCountEls.forEach(el => el.textContent = cart.item_count);
      console.log("ğŸ§® Updated cart count:", cart.item_count);

      // 2. Open drawer using native trigger
      const trigger = document.querySelector('[data-hdt-open-drawer="cart"], [data-open-drawer="cart"]');
      if (trigger) {
        trigger.click();
        console.log("ğŸ›ï¸ Simulated click on drawer trigger");
      } else {
        console.warn("âŒ Could not find cart drawer trigger");
      }
    });
}

</script>
