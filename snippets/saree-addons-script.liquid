<script>
document.addEventListener("DOMContentLoaded", function () {
  const atcForm = document.querySelector('form[action="/cart/add"]');
  if (!atcForm) {
    console.warn("ðŸ§© No ATC form found");
    return;
  }

  const atcButton = atcForm.querySelector('button[type="submit"]');
  const debugPrefix = "ðŸ§© ADDON:";

  function removeOldAddonInputs() {
    atcForm.querySelectorAll(".addon-dynamic").forEach(el => el.remove());
  }

  function injectAddonInputs() {
    removeOldAddonInputs();
    const selected = document.querySelectorAll(".addon-checkbox:checked");
    console.log(`ðŸ“¦ Add-ons selected: ${selected.length}`);

    selected.forEach((checkbox) => {
      const variantId = checkbox.dataset.variantId;
      if (!variantId) return;
      console.log(`${debugPrefix} Injecting addon variant ${variantId}`);

      const idInput = document.createElement("input");
      idInput.type = "hidden";
      idInput.name = "items[][id]";
      idInput.value = variantId;
      idInput.classList.add("addon-dynamic");

      const qtyInput = document.createElement("input");
      qtyInput.type = "hidden";
      qtyInput.name = "items[][quantity]";
      qtyInput.value = "1";
      qtyInput.classList.add("addon-dynamic");

      atcForm.appendChild(idInput);
      atcForm.appendChild(qtyInput);
    });
  }

  function removeExistingSareeAndAddons(parentVariantId) {
    return fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const updates = {};
        cart.items.forEach(item => {
          const isParent = item.variant_id === parentVariantId;
          const isAddon = item.properties && item.properties['Linked to Saree'] == parentVariantId;
          if (isParent || isAddon) {
            updates[item.key] = 0;
            console.log('ðŸ§¹ Marking for removal:', item.key, item.title);
          }
        });

        if (Object.keys(updates).length > 0) {
          console.log('ðŸ§¹ Sending cart update to remove old items...');
          return fetch('/cart/update.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ updates })
          }).then(() => {
            console.log('âœ… Old items removed.');
          });
        } else {
          console.log('âš ï¸ No matching old items found.');
          return Promise.resolve();
        }
      })
      .catch(err => {
        console.error('âŒ Error removing old items', err);
      });
  }

  atcForm.addEventListener("submit", function (e) {
    e.preventDefault(); // prevent default submission

    const parentVariantId = parseInt(window.product?.selected_or_first_available_variant?.id || 0);
    if (!parentVariantId) {
      console.warn("âš ï¸ Cannot find parent variant ID");
      atcForm.submit(); // fallback
      return;
    }

    console.log("ðŸ§¹ Cleaning old saree & add-ons before adding...");

    removeExistingSareeAndAddons(parentVariantId).then(() => {
      injectAddonInputs();
      atcForm.submit(); // now safely submit
    });
  });

  atcButton?.addEventListener("click", function () {
    // Hook here just for added safety
    injectAddonInputs();
  });
});
</script>
